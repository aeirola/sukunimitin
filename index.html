<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Sukunimitin</title>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.12.3/xlsx.core.min.js"></script>
	<script type="text/javascript">
		"use strict";
		const CHAIN_SIZE = 3;
		const MAX_LENGTH = 15;
		const NUMBER_OF_NAMES = 10;

		const storageKey = "sukunimitilasto.xlsx";
		const delimiter = ",";
		const nameListUrl = 'https://www.avoindata.fi/data/dataset/57282ad6-3ab1-48fb-983a-8aba5ff8d29a/resource/d25831d1-82a9-476f-8f7c-374c348efc14/download/sukunimitilasto-2017-09-04-vrk.xlsx';
		const nameValidateUrl = 'https://sukunimitin-api.herokuapp.com/isAvailable';
		
		/* Bootstrapping */
		window.onload = () =>
			loadNames()
				.then(names =>
					createModel(names)
						.then(model => initUI(model, names))
				)
				.catch(console.error);

		/* Source data handling */
		function loadDataRemote() {
			return fetch(nameListUrl)
				.then(response => response.blob())
				.then(blob => new Promise((resolve, reject) => {
					const reader = new FileReader();
					reader.addEventListener("loadend", () => resolve(new Uint8Array(reader.result)));
					reader.addEventListener("onerror", reject);
					reader.readAsArrayBuffer(blob);
				}))
				.then(data => XLSX.read(data, {type: 'array'}))
		        .then(workbook => workbook.Sheets['Nimet'])
		        .then(worksheet => XLSX.utils.sheet_to_json(worksheet))
		        .then(json => json.map(row => row['Sukunimi']));
		}
		function loadDataLocal() {
			const data = localStorage.getItem(storageKey);
			return data
				? Promise.resolve(data.split(delimiter))
				: Promise.reject();
		}
		function storeDataLocal(data) {
			localStorage.setItem(storageKey, data.join(delimiter));
			return Promise.resolve(data);
		}

		function loadNames() {
			return loadDataLocal()
				.catch(() => loadDataRemote().then(storeDataLocal));
		}

		/* Name validation */
		function validateNameRemote(name) {
			return fetch(nameValidateUrl + '?name=' + name)
				.then(response => response.json())
				.then(data => data.available
					? Promise.resolve(name)
					: Promise.reject(name));
		}
		function validateNameLocal(name, names) {
			if (names.indexOf(name) >= 0) {
				return Promise.reject(name);
			} else {
				return Promise.resolve(name);
			}
		}
		function validateName(name, names) {
			return validateNameLocal(name, names)
				.then(() => validateNameRemote(name));
		}

		/* Model creation */
		function createModel(names) {
			const model = {};
			names.forEach(name => {
				for (let characterIndex = 0 ; characterIndex <= name.length ; characterIndex++ ) {
					const prefix = name.slice(Math.max(characterIndex-CHAIN_SIZE, 0), characterIndex);
					model[prefix] = model[prefix] || [];
					model[prefix].push(name[characterIndex]);
				}
			});
			return Promise.resolve(model);
		}

		/* Name generation */
		function generateName(model) {
			let name = '', prefix = '';
			do {
				const choices = model[prefix] || [];
				const selectedIndex = Math.floor(Math.random() * choices.length);
				const selectedCharacter = choices[selectedIndex];
				if (!selectedCharacter) {
					break;
				}
				name += selectedCharacter;
				prefix += selectedCharacter;
				if (prefix.length > CHAIN_SIZE) {
					prefix = prefix.slice(1);
				}
			} while (name.length <= MAX_LENGTH);

			if (name.length > MAX_LENGTH) {
				return Promise.reject();
			} else {
				return Promise.resolve(name);
			}
		}

		/* UI control */
		function initUI(model, names) {
			generateNewNames(model, names);
			document.addEventListener("click", () => generateNewNames(model, names));
			document.body.className = 'loaded';
		}

		function generateNewNames(model, names) {
			clearNames();
			for (let i = 0 ; i < NUMBER_OF_NAMES ; i++) {
				generateName(model)
					.then(name => {
						const element = displayName(name);
						validateName(name, names)
							.then(
								() => element.className = 'available',
								() => element.className = 'unavailable',
						);
					},
					() => undefined, // Name generation failed, ignoring
				);
			}
		}

		function clearNames() {
			document.getElementById('names').innerHTML = '';
		}

		function displayName(name) {
			const element = document.createElement('li');
			element.appendChild(document.createTextNode(name));
			document.getElementById('names').appendChild(element);
			return element;
		}

	</script>

	<style type="text/css">
		html {
			height: 100%;
			width: 100%;
			display: flex;
		}
		body {
			flex: 1;
			margin: 0;
			display: flex;
			flex-direction: column;

			font-family: monospace;
			text-align: center;
			font-size: 16pt;
		}
		.loading:before {
			content: 'Ladataan...';
			position: absolute;
			top: 50%;
			width: 100%;
		}

		ul {
			padding: 0;
		}
		li {
			list-style: none;
			opacity: 0.5;
		}
		.available {
			opacity: 1;
		}
		.unavailable {
			opacity: 0.25;
			text-decoration: line-through;
		}

		section {
			flex-grow: 1;
		}
		footer {
			padding: 2rem;
			font-size: 50%;
			opacity: 0.75;
		}
		footer p {
			margin: 0;
		}
		footer a {
			color: black;
		}
	</style>
</head>
<body class="loading">
	<header>
		<h1>Sukunimitin</h1>
	</header>
	<section>
		<ul id="names"></ul>
	</section>
	<footer>
		<p>
			Paina lataaksesi lisää nimiä.
		</p>
		<p>
			Lähdeaineisto <a href="https://www.avoindata.fi/data/fi/dataset/none">Väestörekisterikeskuksen sukunimitilasto</a>.
		</p>
		<p>
			Luodut nimet varmistetaan <a href="http://verkkopalvelu.vrk.fi/nimipalvelu/">Väestörekisterikeskuksen nimipalvelusta</a>.
		</p>
	</footer>
</body>
</html>